# Как сэмулировать функцию `XLOOKUP`

Допустим, нам нужна таблица расходов и балансов, расписанных по банкам. Новые записи добавляются снизу хронологически, но по банкам - в произвольном порядке. Чтобы таблица заработала, надо для каждой новой записи расходов найти последнюю запись по банку, вычесть из него сумму и показать результат.

|    |A|B|C|D|
|--- |--- |--- |--- |--- |
|1   |дата 	|банк 	|сумма 	|баланс |
|2   |09.10.25 	|сбербанк 	| 	|2 000,00 ₽ |
|3   |09.10.25 	|альфабанк 	| 	|4 000,00 ₽ |
|4   |09.10.25 	|втб 	| 	|5 000,00 ₽ |
|5   |10.10.25 	|сбербанк 	|10,00 ₽ 	|1 990,00 ₽ |
|6   |11.10.25 	|сбербанк 	|900,00 ₽ 	|1 090,00 ₽ |
|7   |11.10.25 	|альфабанк 	|10,00 ₽ 	|3 990,00 ₽ |
|8   |11.10.25 	|сбербанк 	|25,00 ₽ 	|1 065,00 ₽ |
|9   |11.10.25 	|альфабанк 	|50,00 ₽ 	|3 940,00 ₽ |
|10  |14.10.25 	|втб 	|50,00 ₽ 	|4 950,00 ₽ |
|11  |14.10.25 	|сбербанк 	|100,00 ₽ 	|965,00 ₽ |
|12  |14.10.25 	|втб 	|100,00 ₽ 	|4 850,00 ₽ |
|13  |18.10.25 	|втб 	|100,00 ₽ 	|4 750,00 ₽ |

В Microsoft Excel и последних версиях LibreOffice есть замечательная функция `XLOOKUP`. Для нашего случая работает она так (для 13-ой строки таблицы):

```
=XLOOKUP(
	B13;
	$B$2:B12;
	$D$2:D12;
	;
	0;
	-1
)
```

Для значение из ячейки `B13` производится обратный поиск (`-1`) на точное соответствие (`0`) в диапазоне `$B$2:B12`. Для найденного значения в столбце `B` возвращается соответствующее значение из столбца `D`.

Если функция не поддерживается, а использовать ее хочется, то приходится эмулировать. Вот таблица, в которой собраны все формулы.

|    |A|B|C|D|E|F|G|
|--- |--- |--- |--- |--- |--- |--- |--- |
|1   |дата 	|банк 	|сумма 	|баланс 	|предыдущий баланс через xlookup 	|предыдущий баланс через эмуляцию 	|количество предыдущих записей |
|2   |09.10.25 	|сбербанк 	| 	|2 000,00 ₽ 	| 	| 	|0 |
|3   |09.10.25 	|альфабанк 	| 	|4 000,00 ₽ 	| 	| 	|1 |
|4   |09.10.25 	|втб 	| 	|5 000,00 ₽ 	| 	| 	|2 |
|5   |10.10.25 	|сбербанк 	|10,00 ₽ 	|1 990,00 ₽ 	|2 000,00 ₽ 	|2 000,00 ₽ 	|3 |
|6   |11.10.25 	|сбербанк 	|900,00 ₽ 	|1 090,00 ₽ 	|1 990,00 ₽ 	|1 990,00 ₽ 	|4 |
|7   |11.10.25 	|альфабанк 	|10,00 ₽ 	|3 990,00 ₽ 	|4 000,00 ₽ 	|4 000,00 ₽ 	|5 |
|8   |11.10.25 	|сбербанк 	|25,00 ₽ 	|1 065,00 ₽ 	|1 090,00 ₽ 	|1 090,00 ₽ 	|6 |
|9   |11.10.25 	|альфабанк 	|50,00 ₽ 	|3 940,00 ₽ 	|3 990,00 ₽ 	|3 990,00 ₽ 	|7 |
|10  |14.10.25 	|втб 	|50,00 ₽ 	|4 950,00 ₽ 	|5 000,00 ₽ 	|5 000,00 ₽ 	|8 |
|11  |14.10.25 	|сбербанк 	|100,00 ₽ 	|965,00 ₽ 	|1 065,00 ₽ 	|1 065,00 ₽ 	|9 |
|12  |14.10.25 	|втб 	|100,00 ₽ 	|4 850,00 ₽ 	|4 950,00 ₽ 	|4 950,00 ₽ 	|10 |
|13  |18.10.25 	|втб 	|100,00 ₽ 	|4 750,00 ₽ 	|4 850,00 ₽ 	|4 850,00 ₽ 	|11 |


Для этого потребуется вспомогательный столбец для подсчета количества предыдущих записей в таблице. Так как первая строка - это заголовок, то количество предыдущих записей будет равно `=ROW()-2`. Эта формула записана в ячейках столбца `G`.

```
=INDEX(
	$D$2:D12;
	MATCH(
		MAXIFS(
			$G$2:G12;
			$B$2:B12;
			B13
		);
		$G$2:G12;
		0
	);
	1
)
```

Чтобы понять всю вакханалию, творящуюся здесь, надо начать читать изнутри.

Функция `MAXIFS` ищет все вхождения значения в ячейке `B13` (текущий банк) в диапазоне `$B$2:B12` (имена банков). Для каждого найденного значения выбираются значения из диапазона `$G$2:G12` (количества записей), для которых находится максимальное. В нашем случае это число `10`. 

Функция `MATCH` ищет это число в диапазоне `$G$2:G12` (получается уже повторный поиск) и возвращает его индекс.

Функция `INDEX`, используя результат предыдущей функции, из диапазона `$D$2:D12` (значения балансов) по индексу возвращает значение. В нашей задаче это предыдущий баланс для этого банка.
